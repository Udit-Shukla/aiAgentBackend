name: Deploy to DigitalOcean

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload Nginx config
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          source: nginx.conf
          target: /tmp/deploy-configs

      - name: SSH into Droplet and deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            set -e

            echo "üì¶ Installing dependencies..."
            apt-get update
            apt-get install -y nginx certbot python3-certbot-nginx git

            echo "üîê Configuring firewall..."
            ufw allow 'Nginx Full'
            ufw allow OpenSSH
            ufw delete limit 22/tcp || true
            ufw allow 22/tcp
            ufw --force enable

            echo "üìÅ Updating nginx.conf if changed..."
            if ! cmp -s /tmp/deploy-configs/nginx.conf /etc/nginx/sites-available/aiagent-backend; then
              mv /tmp/deploy-configs/nginx.conf /etc/nginx/sites-available/aiagent-backend
              ln -sf /etc/nginx/sites-available/aiagent-backend /etc/nginx/sites-enabled/default
              nginx -t && systemctl reload nginx
            else
              echo "No changes to nginx.conf"
            fi

            echo "üîí Checking SSL certificate..."
            if [ ! -f /etc/letsencrypt/live/aiagents.worxstream.io/fullchain.pem ]; then
              certbot --nginx -d aiagents.worxstream.io --non-interactive --agree-tos --email ${{ secrets.EMAIL }}
            else
              echo "SSL certificate already exists"
            fi

            echo "üì• Updating application code..."
            APP_DIR=/root/aiAgentBackend
            if [ ! -d "$APP_DIR" ]; then
              git clone https://github.com/Udit-Shukla/aiAgentBackend.git $APP_DIR
            fi
            cd $APP_DIR
            git reset --hard
            git pull origin main

            echo "üê≥ Rebuilding Docker container..."
            if [ ! -f .env ]; then touch .env; fi
            docker stop aiagent-backend || true
            docker rm aiagent-backend || true
            docker build --pull -t aiagent-backend .
            docker run -d --name aiagent-backend -p 8000:8000 --env-file .env aiagent-backend

name: Deploy to DigitalOcean

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Upload Nginx config
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          source: nginx.conf
          target: /tmp/nginx.conf

      - name: SSH into Droplet and deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            # Ensure required packages
            apt-get update
            apt-get install -y nginx certbot python3-certbot-nginx git

            # Allow HTTP/HTTPS traffic
            ufw allow 'Nginx Full'
            ufw allow OpenSSH
            ufw --force enable

            # Deploy nginx config
            mv /tmp/nginx.conf /etc/nginx/sites-available/aiagent-backend
            ln -sf /etc/nginx/sites-available/aiagent-backend /etc/nginx/sites-enabled/default

            # Test and reload Nginx
            nginx -t && systemctl reload nginx

            # Issue SSL cert (will fail if domain is not pointing to droplet)
            certbot --nginx -d aiagents.worxstream.io --non-interactive --agree-tos --email ${{ secrets.EMAIL }}

            # Clone repo if not already cloned
            APP_DIR=/root/aiAgentBackend
            if [ ! -d "$APP_DIR" ]; then
              git clone https://github.com/Udit-Shukla/aiAgentBackend.git $APP_DIR
            fi
            cd $APP_DIR
            git reset --hard
            git pull origin main

            # Build and run Docker
            if [ ! -f .env ]; then touch .env; fi
            docker stop aiagent-backend || true
            docker rm aiagent-backend || true
            docker build -t aiagent-backend .
            docker run -d --name aiagent-backend -p 8000:8000 --env-file .env aiagent-backend
